<?xml version="1.0"?>
<macros>
    <xml name="requirements">
        <requirements>
           <requirement type="package" version="1.4.4" >bioconductor-mspurity</requirement>
           <requirement type="package" version="1.4.4" >r-optparse</requirement>
            <yield />
        </requirements>

    </xml>

    <xml name="offsets">
            <param name="minoffset" type="float" label="minoffset" value="0.5"
                    help="Offset to the 'left' for the precursor range e.g. if precursor of interest is
                    100.0 then the range would be from 999.5 to 100.0"/>
        <param name="maxoffset" type="float" label="maxoffset" value="0.5"
                    help="Offset to the 'right' for the precursor range  e.g. if precursor of interest is
                    100.0 then the range would be from 100.0 to 100.5"/>
    </xml>
    <xml name="general_params">

        <param name="ilim" type="float" label="ilim" value="0.05"
                    help="All peaks less than this percentage of the target peak will be removed
                    from the purity calculation, default is 5\% (0.05)"/>

        <param name="iw_norm" type="select" label="Normalisation for isolation efficiency">
                <option value="gauss" >Gaussian</option>
                <option value="rcosine" >Raised cosine</option>
                <option value="QE5"> Calculated from Q-Exactive for +/- 0.5 Da windows </option>
                <option value="none" selected="true" >No normalisation</option>
        </param>

        <conditional name="isotopes">
            <param name="isotopes" type="select" label="Handling of isotopic peaks" >
                <option value="keep" >Keep isotopes in precursor ion purity calculation</option>
                <option value="exclude_default" selected="true" >Exclude C12/C13 isotopes in precursor ion purity calculation</option>
                <option value="user" >Exclude a user supplied list of isotopes in purity calculation</option>
            </param>
            <when value="keep">
            </when>
            <when value="exclude_default">
            </when>
            <when value="user">
                <param name="im" type="data" format="tabular" label="Isotope matrix" help="
                 tabular file composing of columns:
                  ['isotope_id', 'mass diff', 'abundance of isotope', 'ppm tol for mz', 'abundance buffer',
                                  'charge', 'relative atomic mass (int)', 'xflag'].
                The xflag indicates if the larger (mass) isotope is the most abundant or less abundant.
                e.g. for c12 to c13, the c13 is less abundant so we flag as 1 for Li6 to Li7, the Li7 is more abundant
                so we would flag as 0.
                Example row: For C13 isotope (single charge) the row could be [1, 1.003355, 1.07, 4, 0.1, 1, 12, 1]"/>
            </when>
        </conditional>
    </xml>



    <xml name="purityA">
        <param name="mostIntense" type="boolean" checked="true" label="Use most intense peak within isolation window for precursor?"
               help="If yes, this will ignore the recorded precursor within the mzML file and use
               use the most intense peak within the isolation window to calculate the precursor ion purity"/>

        <param name="nearest" type="boolean" checked="true" label="Use nearest full scan to determine precursor?"
               help="If yes, this will use the neareset full scan to the fragmentation scan to determine what the m/z value
                     is of the precursor"/>


        <conditional name="offsets">
            <param name="offsets" type="select" label="offsets" >
                <option value="auto" selected="true">Uses offsets determined in the mzML file</option>
                <option value="user">User supplied offset values</option>
            </param>
            <when value="user">
                <expand macro="offsets" />
            </when>
	        <when value="auto">
            </when>

        </conditional>
    </xml>

    <xml name="frag4feature">
            <param name="mostIntense_f4f" type="boolean" checked="true" label="For matching fragmentation to a feature, use most intense peak within isolation window for precursor?"
               />

        <param name="convert2RawRT_f4f" type="boolean" checked="false" label="Was retention time correction used?"
               help="If retention time correction has been used in XCMS set this to yes"/>

        <param name="ppm_f4f" type="float" label="ppm" value="10"
                    help="ppm tolerance between precursor mz and feature mz"/>

        <param name="plim_f4f" type="float" label="plim" value="0" max="1" min="0"
                    help="min purity of precursor to be included"/>
    </xml>

    <xml name="fileload">
            <conditional name="file_load_conditional">
                <param name="file_load_select" type="select" label="Resubmit your dataset"
                       help="Use only if you get a message which say that your original dataset or
                                dataset collection can not be found the server." >
                    <option value="no" >no need</option>
                    <option value="yes" >yes</option>
                </param>
                <when value="no">
                </when>
                <when value="yes">
                    <param name="input" type="data_collection" collection_type="list"  format="mzxml,mzml,mzdata,netcdf"
                           multiple="true" label="File(s) from your history containing your chromatograms"
                           help="Select the dataset collection containing the files that were used
                                 for processing" />
                </when>
        </conditional>
    </xml>


    <token name="@purityA@">
        #if $offsets.offsets == 'user'
                --minOffset=$minoffset
                --maxOffset=$maxoffset
            #end if

            --iwNorm=$iw_norm
            --ilim=$ilim

            #if $nearest
                --nearest
            #end if

            #if $mostIntense
                --mostIntense
            #end if

            #if $isotopes.isotopes == "exclude_default"
                --exclude_isotopes
            #elif $isotopes.isotopes == "user"
                --exclude_isotopes
                --isotope_matrix=$isotopes.im
        #end if
     </token>

    <token name="@frag4feature@">
            --ppm=$ppm_f4f
            --plim=$plim_f4f
            #if $mostIntense_f4f
                --mostIntense
            #end if
            #if $convert2RawRT_f4f
                --convert2RawRT
            #end if
     </token>

    <xml name="citations">
        <citations>
            <citation type="doi">10.1021/acs.analchem.6b04358</citation>
            <yield />
        </citations>
    </xml>

</macros>
